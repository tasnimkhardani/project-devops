pipeline {
    agent any

    environment {
        BACKEND_IMAGE   = "bnbttf123/backend-image:latest"
        DASHBOARD_IMAGE = "bnbttf123/dashboard-image:latest"
    }

    stages {

        /* --------------------- CHECKOUT --------------------- */
        stage('Checkout') {
            steps {
                git branch: 'main', 
                    credentialsId: 'github', 
                    url: 'git@github.com:tasnimkhardani/project-devops.git'
            }
        }

        /* ---------------------- SETUP ------------------------ */
        stage('Setup') {
            steps {
                bat "echo Setup OK > setup.log"
            }
        }

        /* ---------------------- CLEANUP ------------------------ */
        stage('Cleanup') {
            steps {
                bat """
                    docker rm -f dashboard || echo OK
                    docker rm -f backend || echo OK
                    docker rm -f mongodb || echo OK

                    docker rmi -f  %DASHBOARD_IMAGE% || echo ok 
                    docker rmi -f  %BACKEND_IMAGE% || echo ok  
                    docker rmi -f  mongo:latest || echo ok
                """
            }
        }

        /* ---------------------- BUILD ------------------------ */
        stage('Build Docker Images') {
            steps {
                bat """
                    echo Building backend image...
                    docker build -t %BACKEND_IMAGE% -f backend/dockerfile .

                    echo Building dashboard image...
                    docker build -t %DASHBOARD_IMAGE% -f dashboard/dockerfile .
                """
            }
        }

        /* ---------------------- SECURITY ------------------------ */
        stage('Vulnerability Scan (Trivy)') {
            steps {
                bat """
                    trivy image --exit-code 0 --severity HIGH,CRITICAL %BACKEND_IMAGE%
                    trivy image --exit-code 0 --severity HIGH,CRITICAL %DASHBOARD_IMAGE%
                """
            }
        }

        /* ---------------------- RUN (DOCKER) ----------------------- */
        stage('Run MongoDB') {
            steps {
                bat """
                    echo Starting MongoDB...
                    docker run -d --name mongodb ^
                    -p 4000:27017 ^
                    -e MONGO_INITDB_ROOT_USERNAME=admin ^
                    -e MONGO_INITDB_ROOT_PASSWORD=dwXJmJVrSvXpVUML ^
                    mongo:latest
                """
                
            }
        }

        stage('Run Backend') {
            steps {
                bat """
                    echo Starting backend...
                    docker run -d --name backend ^
                    -p 3000:80 ^
                    -e PORT=80 ^
                    -e DATABASE=mongodb://admin:dwXJmJVrSvXpVUML@mongodb/mapApp?retryWrites=true&w=majority&appName=map-app&authSource=admin ^
                    --link mongodb:mongodb ^
                    %BACKEND_IMAGE%
                """
            }
        }

        stage('Run Dashboard') {
            steps {
                bat """
                    echo Starting dashboard...
                    docker run -d --name dashboard ^
                    -p 3001:80 ^
                    -e PORT=80 ^
                    --link backend:backend ^
                    %DASHBOARD_IMAGE%
                """
            }
        }

        /* ---------------------- SMOKE TEST --------------------- */
        stage('Smoke Tests') {
            steps {
                bat """
                    powershell -Command "try { Invoke-WebRequest http://localhost:3000/health -OutFile smoke_backend.log } catch { exit 1 }"
                    powershell -Command "try { Invoke-WebRequest http://localhost:3001 -OutFile smoke_dashboard.log } catch { exit 1 }"
                """
            }
        }


        /* ---------------------- ARCHIVE ------------------------ */
       stage('Archive Artifacts') {
          steps {
              echo "Archiving logs and smoke test results..."
              archiveArtifacts artifacts: 'setup.log, smoke-test/*.log', allowEmptyArchive: true
    }
}



    }
}

